<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Public Client Sample</title>
</head>

<body>
    <h1>Public Client Sample</h1>
    <button id="startButton">Start OAuth Flow</button>
    <div id="result"></div>
    <script>
        const issuer = 'http://idp.byo.one/auth/realms/byoone'
        const authorizeEndpoint = "http://idp.byo.one/auth/realms/byoone/protocol/openid-connect/auth";
        const tokenEndpoint = "http://idp.byo.one/auth/realms/byoone/protocol/openid-connect/token";
        const clientId = "byo.one";

        if (window.location.search) {
            var args = new URLSearchParams(window.location.search);
            var code = args.get("code");

            if (code) {
                fetch(tokenEndpoint,
                    {
                        method: 'POST',
                        headers: new Headers(
                            {
                                "Content-Type": "application/x-www-form-urlencoded",
                                "Accept": "application/json"
                            }
                        ),
                        body: new URLSearchParams({
                            client_id: clientId,
                            code_verifier: window.sessionStorage.getItem("code_verifier"),
                            grant_type: "authorization_code",
                            redirect_uri: location.href.replace(location.search, ''),
                            code: code
                        })
                    }
                ).then(response => {
                    response.json().then(t => {
                        let message = `
                            <ul>
                                <li>access token: <a href="https://jwt.io?token=${t.access_token}">${t.access_token}</a></li>
                                <li>refresh token:  <a href="https://jwt.io?token=${t.refresh_token}">${t.refresh_token}</a></li>
                                <li>id token:  <a href="https://jwt.io?token=${t.id_token}">${t.id_token}</a></li>
                            </ul>
                        `;
                        document.getElementById("result").innerHTML = message
                    });
                })
                .catch(error => {
                    let message = "Error: " + error;
                    document.getElementById("result").innerHTML = message;
                    location.search = null;
                });
            }
        }

        document.getElementById("startButton").onclick = function () {
            var codeVerifier = generateRandomString(64);

            generateCodeChallenge(codeVerifier).then(function (codeChallenge) {
                window.sessionStorage.setItem("code_verifier", codeVerifier);

                var redirectUri = window.location.href.split('?')[0];
                var args = new URLSearchParams({
                    response_type: "code",
                    client_id: clientId,
                    code_challenge_method: "S256",
                    code_challenge: codeChallenge,
                    redirect_uri: redirectUri,
                    scope: 'openid profile email',
                    state: 'mystate',
                    nonce: 'mynonce'
                });
                window.location = authorizeEndpoint + "?" + args;
            });
        }

        async function generateCodeChallenge(codeVerifier) {
            var digest = await crypto.subtle.digest("SHA-256",
                new TextEncoder().encode(codeVerifier));

            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_')
        }

        function generateRandomString(length) {
            var text = "";
            var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

            for (var i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }

            return text;
        }
    </script>
</body>

</html>